{% extends 'projects/base.html' %}

{% block title %}{{ project.title }} - DX Consulting CRM{% endblock %}

{% block content %}
<div style="margin-bottom: 1rem;">
    <a href="{% url 'projects:project_list' %}" class="btn btn-secondary">â† æ¡ˆä»¶ä¸€è¦§ã«æˆ»ã‚‹</a>
</div>

<h1 style="margin-bottom: 2rem;">{{ project.title }}</h1>

<!-- åŸºæœ¬æƒ…å ± -->
<div class="card">
    <h2>ğŸ“‹ åŸºæœ¬æƒ…å ±</h2>
    <div class="grid grid-2">
        <div>
            <p><strong>é¡§å®¢:</strong> {{ project.client.company_name }}</p>
            <p><strong>æ‹…å½“è€…:</strong> {{ project.client.contact_person }}</p>
            <p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> 
                {% if project.status == 'inquiry' %}<span class="badge badge-info">åˆå›ç›¸è«‡</span>
                {% elif project.status == 'hearing' %}<span class="badge badge-primary">ãƒ’ã‚¢ãƒªãƒ³ã‚°ä¸­</span>
                {% elif project.status == 'proposal' %}<span class="badge badge-warning">ææ¡ˆä½œæˆä¸­</span>
                {% elif project.status == 'quotation' %}<span class="badge badge-warning">è¦‹ç©æç¤º</span>
                {% elif project.status == 'negotiation' %}<span class="badge badge-warning">å•†è«‡ä¸­</span>
                {% elif project.status == 'handover' %}<span class="badge badge-info">ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å¼•ç¶™ã</span>
                {% elif project.status == 'in_progress' %}<span class="badge badge-success">å®Ÿæ–½ä¸­</span>
                {% elif project.status == 'completed' %}<span class="badge badge-success">å®Œäº†</span>
                {% elif project.status == 'on_hold' %}<span class="badge">ä¿ç•™</span>
                {% elif project.status == 'lost' %}<span class="badge badge-danger">å¤±æ³¨</span>
                {% endif %}
            </p>
        </div>
        <div>
            <p><strong>è¦‹ç©é‡‘é¡:</strong> {% if project.estimated_amount %}Â¥{{ project.estimated_amount|floatformat:0 }}{% else %}æœªè¨­å®š{% endif %}</p>
            <p><strong>é–‹å§‹äºˆå®šæ—¥:</strong> {% if project.start_date %}{{ project.start_date|date:"Yå¹´mæœˆdæ—¥" }}{% else %}æœªè¨­å®š{% endif %}</p>
            <p><strong>å®Œäº†äºˆå®šæ—¥:</strong> {% if project.end_date %}{{ project.end_date|date:"Yå¹´mæœˆdæ—¥" }}{% else %}æœªè¨­å®š{% endif %}</p>
        </div>
    </div>
</div>

<!-- ã”ç›¸è«‡å†…å®¹ -->
<div class="card">
    <h2>ğŸ’¬ ã”ç›¸è«‡å†…å®¹</h2>
    <div style="white-space: pre-wrap; line-height: 1.8;">{{ project.consultation_content|default:"è¨˜è¼‰ãªã—" }}</div>
</div>

<!-- ææ¡ˆå†…å®¹ -->
<div class="card">
    <h2>ğŸ“ ææ¡ˆå†…å®¹</h2>
    <div style="white-space: pre-wrap; line-height: 1.8;">{{ project.proposal_content|default:"ã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“" }}</div>
</div>

<!-- å¼•ç¶™ãè¨˜éŒ² -->
<div class="card">
    <h2>ğŸ”„ å¼•ç¶™ãè¨˜éŒ²</h2>
    {% if handovers %}
    <table>
        <thead>
            <tr>
                <th>å¼•ç¶™ãå…ˆ</th>
                <th>æ‹…å½“è€…</th>
                <th>å¼•ç¶™ãæ—¥æ™‚</th>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th>å†…å®¹</th>
            </tr>
        </thead>
        <tbody>
            {% for handover in handovers %}
            <tr>
                <td>{{ handover.get_handover_type_display }}</td>
                <td>{{ handover.handover_to }}</td>
                <td>{{ handover.handover_date|date:"Y/m/d H:i" }}</td>
                <td>
                    {% if handover.is_completed %}
                    <span class="badge badge-success">å®Œäº†</span>
                    {% else %}
                    <span class="badge badge-warning">å¯¾å¿œä¸­</span>
                    {% endif %}
                </td>
                <td style="max-width: 300px;">{{ handover.handover_content|truncatewords:20 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>å¼•ç¶™ãè¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}
</div>

<!-- ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒãƒˆãƒ³ã‚¿ãƒƒãƒ -->
<div class="card">
    <h2>ğŸ‘¨â€ğŸ’» ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒãƒˆãƒ³ã‚¿ãƒƒãƒè¨˜éŒ²</h2>
    {% if engineer_handoffs %}
    <table>
        <thead>
            <tr>
                <th>ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢</th>
                <th>å¼•ç¶™ãæ—¥æ™‚</th>
                <th>äºˆç®—</th>
                <th>æ‰¿èªçŠ¶æ³</th>
                <th>å¯¾å¿œç¯„å›²</th>
            </tr>
        </thead>
        <tbody>
            {% for handoff in engineer_handoffs %}
            <tr>
                <td><strong>{{ handoff.engineer_name }}</strong></td>
                <td>{{ handoff.handoff_date|date:"Y/m/d H:i" }}</td>
                <td>{% if handoff.budget %}Â¥{{ handoff.budget|floatformat:0 }}{% else %}æœªè¨­å®š{% endif %}</td>
                <td>
                    {% if handoff.is_accepted %}
                    <span class="badge badge-success">æ‰¿èªæ¸ˆã¿</span>
                    {% else %}
                    <span class="badge badge-warning">æ‰¿èªå¾…ã¡</span>
                    {% endif %}
                </td>
                <td style="max-width: 300px;">{{ handoff.technical_scope|truncatewords:15 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¸ã®ãƒãƒˆãƒ³ã‚¿ãƒƒãƒè¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}
</div>

<!-- é€²æ—è¨˜éŒ² -->
<div class="card">
    <h2>ğŸ“… é€²æ—è¨˜éŒ²</h2>
    {% if progress_logs %}
    <table>
        <thead>
            <tr>
                <th>æ—¥æ™‚</th>
                <th>æ´»å‹•ç¨®åˆ¥</th>
                <th>å†…å®¹</th>
                <th>æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                <th>è¨˜éŒ²è€…</th>
            </tr>
        </thead>
        <tbody>
            {% for log in progress_logs %}
            <tr>
                <td>{{ log.log_date|date:"Y/m/d H:i" }}</td>
                <td>{{ log.get_activity_type_display }}</td>
                <td style="max-width: 300px;">{{ log.content|truncatewords:20 }}</td>
                <td style="max-width: 200px;">{{ log.next_action|truncatewords:15|default:"-" }}</td>
                <td>{{ log.created_by }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>é€²æ—è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}
</div>

<div style="margin-top: 1.5rem;">
    <a href="/admin/projects/project/{{ project.pk }}/change/" class="btn btn-primary">ç·¨é›†</a>
    <a href="/admin/projects/progresslog/add/?project={{ project.pk }}" class="btn btn-success">+ é€²æ—è¨˜éŒ²è¿½åŠ </a>
</div>
{% endblock %}
